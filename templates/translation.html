<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì‹¤ì‹œê°„ ë²ˆì—­ - ì„¸ì…˜ ë·° (ë³„ë„ íŒì—… ì°½)</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
    /* â­ï¸ CSS ë³€ìˆ˜ ì„ ì–¸: í°íŠ¸ í¬ê¸° (JSì—ì„œ ë™ì ìœ¼ë¡œ ë³€ê²½) */
    :root {
        --log-font-size: 14px;
        /* ë‹¤í¬ ëª¨ë“œ (ê¸°ë³¸ê°’) ë³€ìˆ˜ */
        --bg-color: #222;
        --text-color: #fff;
        --log-bg: rgba(255,255,255,0.05);
        --original-bg: rgba(255,255,255,0.2);
        --original-text: #fff;
        --translated-bg: rgba(255,255,255,0.8);
        --translated-text: #333;
        --timestamp-color: #ffd700;
        --button-bg: #1dd1a1;
        --button-hover-bg: #10ac84;
        --clear-bg: #f39c12;
        --clear-hover-bg: #e67e22;
        --menu-bg: #333;
        --menu-shadow: 0 6px 12px rgba(0,0,0,0.5);
        --highlight-bg: #444; /* ê²€ìƒ‰ ê²°ê³¼ í•˜ì´ë¼ì´íŠ¸ */
        --border-color: #555;
    }

    /* ë¼ì´íŠ¸ ëª¨ë“œ */
    body.light-mode {
        --bg-color: #f4f4f9;
        --text-color: #333;
        --log-bg: rgba(0,0,0,0.05);
        --original-bg: rgba(0,0,0,0.1);
        --original-text: #333;
        --translated-bg: #007bff;
        --translated-text: #fff;
        --timestamp-color: #007bff;
        --button-bg: #007bff;
        --button-hover-bg: #0056b3;
        --clear-bg: #ffc107;
        --clear-hover-bg: #ffae00;
        --menu-bg: #fff;
        --menu-shadow: 0 6px 12px rgba(0,0,0,0.2);
        --highlight-bg: #e9ecef;
        --border-color: #ddd;
    }

    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        margin:0;
        padding:15px;
        display:flex;
        flex-direction:column;
        height:100vh;
        background: var(--bg-color);
        color: var(--text-color);
        transition: background 0.3s, color 0.3s;
    }

    /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (ì¢Œ/ìš° ë¶„ë¦¬) */
    #button-container {
        display: flex;
        margin-bottom: 15px;
        z-index: 10;
        width: 100%;
        justify-content: space-between;
        position: relative;
    }
    #left-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    #right-buttons {
        display: flex;
        gap: 10px;
        align-items: flex-start;
    }

    /* â­ï¸ [ì‹ ê·œ] ì»¤ìŠ¤í…€ ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    #session-search-container {
        position: relative;
        width: 280px;
        z-index: 15;
    }
    #session-search-input {
        width: 100%;
        padding: 8px 12px;
        border-radius: 20px;
        border: 1px solid var(--border-color);
        background: var(--menu-bg);
        color: var(--text-color);
        font-weight: bold;
        height: 38px;
        box-sizing: border-box;
    }
    #session-search-results {
        display: none;
        position: absolute;
        top: 45px;
        left: 0;
        right: 0;
        max-height: 300px;
        overflow-y: auto;
        background: var(--menu-bg);
        border-radius: 10px;
        box-shadow: var(--menu-shadow);
        border: 1px solid var(--border-color);
        padding: 5px 0;
        z-index: 20;
    }
    .session-item {
        padding: 10px 15px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        font-size: 0.9em;
        line-height: 1.4;
    }
    .session-item:last-child {
        border-bottom: none;
    }
    .session-item:hover, .session-item.highlighted {
        background: var(--highlight-bg);
    }
    /* â­ï¸ íƒ€ì„ë¼ì¸ ì •ë³´ ìŠ¤íƒ€ì¼ */
    .session-item .session-timeline {
        display: block;
        font-size: 0.75em;
        color: var(--timestamp-color);
        margin-top: 3px;
        opacity: 0.8;
    }

    /* â­ï¸ ë²„íŠ¼ ë° ë©”ë‰´ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .all-btn {
        padding:8px 18px;
        cursor:pointer;
        background: var(--button-bg);
        border:none;
        border-radius:20px;
        font-weight:bold;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        transition: background 0.3s, color 0.3s, transform 0.2s;
        color: var(--text-color);
        white-space: nowrap;
        height: 38px;
    }
    .all-btn:hover {
        background: var(--button-hover-bg);
        transform: scale(1.05);
    }
    #clear-log-btn { background: var(--clear-bg); color: #333; }
    #clear-log-btn:hover { background: var(--clear-hover-bg); }
    #utility-dropdown-menu .all-btn { width: 100%; box-shadow: none; border-radius: 8px; padding: 10px 15px; height: auto; }
    #utility-dropdown-menu #diarize-btn { background: #0984e3; }
    #utility-dropdown-menu #diarize-btn:hover { background: #0c70b8; }
    /* #delete-btn ì œê±°ë¨ */
    #session-control-btn { background: var(--button-bg); color: var(--text-color); }
    #session-control-btn.session-active { background-color: #ff6347; color: #fff; }
    #session-control-btn.session-active:hover { background-color: #d9534f; transform: scale(1.05); }
    #utility-menu-toggle { padding: 8px 12px; font-size: 1.2em; }
    #utility-dropdown-menu { display: none; position: absolute; top: 50px; right: 0; padding: 10px; background: var(--menu-bg); border-radius: 10px; box-shadow: var(--menu-shadow); z-index: 20; flex-direction: column; gap: 10px; border: 1px solid rgba(255,255,255,0.1); width: 240px; }

    /* í°íŠ¸/ì¤Œ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    .setting-item { margin-bottom: 5px; padding: 0; }
    .setting-item label { display: block; margin-bottom: 5px; font-size: 0.9em; font-weight: normal; padding-left: 5px; }
    .zoom-controls { display: flex; justify-content: space-between; align-items: stretch; gap: 0; border-radius: 8px; overflow: hidden; border: 1px solid var(--button-bg); height: 40px; }
    .zoom-controls button { padding: 0 10px; height: 100%; background: var(--button-bg); border: none; border-radius: 0; cursor: pointer; color: var(--text-color); font-weight: bold; box-shadow: none; transition: background 0.3s; flex-grow: 1; flex-shrink: 0; font-size: 1.0em; width: auto; }
    .zoom-controls button:hover { background: var(--button-hover-bg); transform: none; }
    #zoom-level, #font-size-level { font-size: 1.0em; font-weight: bold; text-align: center; flex-grow: 2; background: var(--menu-bg); color: var(--text-color); display: flex; align-items: center; justify-content: center; padding: 0 5px; height: 100%; white-space: nowrap; border-left: 1px solid rgba(255, 255, 255, 0.1); border-right: 1px solid rgba(255, 255, 255, 0.1); }

    /* â­ï¸ [ì‹ ê·œ] ì–¸ì–´ ì„ íƒ ë“œë¡­ë‹¤ìš´ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
    #lang-select-container {
        position: relative;
        width: 100%;
        margin-top: 10px; /* ë²„íŠ¼ ê°„ ê°„ê²© ì¶”ê°€ */
    }
    #lang-display-btn {
        width: 100%;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
        /* all-btn ìŠ¤íƒ€ì¼ ìƒì† */
        box-shadow: none;
        border-radius: 8px;
        padding: 10px 15px;
        height: auto;
    }
    .sub-dropdown-menu {
        display: none;
        position: absolute;
        top: 45px;
        left: 0;
        right: 0;
        background: var(--menu-bg);
        border-radius: 8px;
        box-shadow: var(--menu-shadow);
        z-index: 30;
        padding: 5px 0;
        border: 1px solid var(--border-color);
        flex-direction: column;
    }
    .lang-option {
        padding: 10px 15px;
        cursor: pointer;
        text-align: left;
        transition: background 0.2s;
        font-size: 0.9em;
    }
    .lang-option:hover {
        background: var(--highlight-bg);
    }
    .lang-option.active {
        background: var(--button-bg);
        color: var(--text-color);
        font-weight: bold;
    }


    /* ì½˜í…ì¸  ì˜ì—­ */
    #content-container { flex: 1; display: flex; min-height: 0; }
    #log { flex: 1; overflow-y:auto; display:flex; flex-direction:column; gap:12px; padding:12px; border-radius:15px; background: var(--log-bg); transition: background 0.3s; }

    /* ì‹œìŠ¤í…œ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .system-message { text-align: center; font-style: italic; color: var(--timestamp-color); width: 100%; font-size: 0.9em; margin: 5px 0; font-weight: bold; }

    /* ë¡œê·¸ í•­ëª© ìŠ¤íƒ€ì¼ (íƒ€ì„ë¼ì¸ í‘œì‹œ í¬í•¨) */
    .log-entry {
        display:flex;
        flex-direction:column;
        gap:6px;
        opacity:0;
        transform: translateY(10px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        position: relative;
    }
    .log-entry.show { opacity:1; transform: translateY(0); }
    .original-container, .translated-container { display: flex; align-items: flex-end; }
    .original-container { justify-content: flex-start; }
    .translated-container { justify-content: flex-end; }
    .original, .translated {
        max-width:70%;
        padding:10px 14px;
        border-radius:22px;
        word-wrap:break-word;
        font-size: var(--log-font-size);
        transition: background 0.3s, color 0.3s, font-size 0.3s;
        order: 1;
    }
    .original { background: var(--original-bg); color: var(--original-text); }
    .translated { background: var(--translated-bg); color: var(--translated-text); }
    .timestamp {
        font-size:0.75em;
        color: var(--timestamp-color);
        transition: color 0.3s;
        white-space: nowrap;
        margin: 0 5px;
        align-self: flex-end;
        order: 2;
    }
    .translated-container .timestamp { order: 0; margin-right: 0; }
    .original-container .timestamp { margin-left: 0; }


    #summary-log, #summary-content, #summary-close { display: none; }
</style>
</head>
<body>
    <div id="button-container">
        <div id="left-buttons">
            <button id="clear-log-btn" class="all-btn">Clear!</button>
            <button id="session-control-btn" class="all-btn">Start Translation</button>
        </div>

        <div id="right-buttons">
            <div id="session-search-container">
                <input type="text" id="session-search-input" placeholder="ì„¸ì…˜ì„ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ì„¸ìš”..." value="" title="ê¸°ì¡´ ì„¸ì…˜ ê²€ìƒ‰ ë° ë¶ˆëŸ¬ì˜¤ê¸°">
                <div id="session-search-results">
                    </div>
            </div>

            <button id="utility-menu-toggle" class="all-btn" title="ê¸°íƒ€ ê¸°ëŠ¥">â€¢â€¢â€¢</button>

            <div id="utility-dropdown-menu">
                <div class="setting-item">
                    <label>ìš”ì•½ ê¸¸ì´ ì„ íƒ</label>
                    <select id="summary-length-select" class="all-btn" style="width:100%; text-align:center; height:38px;">
                        <option value="short">ì§§ê²Œ (Short)</option>
                        <option value="medium" selected>ë³´í†µ (Medium)</option>
                        <option value="long">ê¸¸ê²Œ (Long)</option>
                    </select>
                </div>

                <button id="toggle-summary" class="all-btn">ìš”ì•½ ìƒì„±</button>
                <button id="diarize-btn" class="all-btn" title="ì„ íƒí•œ ì„¸ì…˜ì„ ë¶„ì„í•©ë‹ˆë‹¤.">í™”ì ë¶„ì„</button>
                <div class="setting-item" id="lang-select-container">
                    <label>ë²ˆì—­ ì–¸ì–´ ì„ íƒ</label>
                    <button class="all-btn" id="lang-display-btn" title="í˜„ì¬ ë²ˆì—­ ë°©í–¥">ğŸ‡°ğŸ‡· í•œêµ­ì–´ -> í•œêµ­ì–´</button>
                    <div id="lang-dropdown-menu" class="sub-dropdown-menu">
                        </div>
                </div>

                <button id="toggle-theme" class="all-btn">ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</button>
                <div class="setting-item">
                    <label>í™”ë©´ í™•ëŒ€/ì¶•ì†Œ</label>
                    <div class="zoom-controls">
                        <button id="zoom-out-btn">-</button>
                        <span id="zoom-level">100%</span>
                        <button id="zoom-in-btn">+</button>
                    </div>
                </div>
                <div class="setting-item">
                    <label>ë²ˆì—­ ë¡œê·¸ í°íŠ¸ í¬ê¸°</label>
                    <div class="zoom-controls">
                        <button id="font-decrease-btn">A-</button>
                        <span id="font-size-level">ê¸°ë³¸</span>
                        <button id="font-increase-btn">A+</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="content-container">
        <div id="log"></div>
    </div>

<script>
    const socket = io();
    const body = document.body;
    const logDiv = document.getElementById("log");
    const logs = [];

    // â­ï¸ [ì‹ ê·œ] ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ ê´€ë ¨ ë³€ìˆ˜
    const sessionSearchInput = document.getElementById("session-search-input");
    const sessionSearchResults = document.getElementById("session-search-results");
    let allSessions = [];
    let selectedSessionId = "";
    let highlightedIndex = -1;

    // â­ï¸ ìœ í‹¸ë¦¬í‹° ë©”ë‰´ ê´€ë ¨ ë³€ìˆ˜
    const utilityMenuToggle = document.getElementById("utility-menu-toggle");
    const utilityDropdownMenu = document.getElementById("utility-dropdown-menu");
    const diarizeBtn = document.getElementById("diarize-btn");
    // const deleteBtn ì œê±°ë¨
    const toggleBtn = document.getElementById("toggle-summary");

    // â­ï¸ [ìˆ˜ì •] ì–¸ì–´ ì„ íƒ ê´€ë ¨ ë³€ìˆ˜
    const langDisplayBtn = document.getElementById("lang-display-btn");
    const langDropdownMenu = document.getElementById("lang-dropdown-menu");

    // â­ï¸ ê¸°íƒ€ ë³€ìˆ˜
    const clearLogBtn = document.getElementById("clear-log-btn");
    const sessionControlBtn = document.getElementById("session-control-btn");
    const themeBtn = document.getElementById("toggle-theme");
    const zoomInBtn = document.getElementById("zoom-in-btn");
    const zoomOutBtn = document.getElementById("zoom-out-btn");
    const zoomLevelSpan = document.getElementById("zoom-level");
    const fontDecreaseBtn = document.getElementById("font-decrease-btn");
    const fontIncreaseBtn = document.getElementById("font-increase-btn");
    const fontSizeLevelSpan = document.getElementById("font-size-level");

    let summaryWindow = null;
    let currentTheme = localStorage.getItem('theme') || 'dark';
    let currentZoom = 1.0;
    const zoomStep = 0.1;
    let currentFontSize = 14;
    const fontSizeStep = 2;

    // â­ï¸ [ìˆ˜ì •] ì–¸ì–´ìŒ ë³€ìˆ˜ ì´ˆê¸°í™”
    let currentSourceLang = localStorage.getItem('source_lang') || 'ko'; // ko, en, ja
    let currentTargetLang = localStorage.getItem('target_lang') || 'ko'; // ko, en

    // â­ï¸ [ìˆ˜ì •] ì–¸ì–´ ì˜µì…˜ ë°ì´í„°
    const langOptions = [
        { source: 'ko', target: 'ko', label: 'ğŸ‡°ğŸ‡· í•œêµ­ì–´ -> í•œêµ­ì–´ (Self)' },
        { source: 'en', target: 'ko', label: 'ğŸ‡ºğŸ‡¸ ì˜ì–´ -> í•œêµ­ì–´' },
        { source: 'ja', target: 'ko', label: 'ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ -> í•œêµ­ì–´' },
        { source: 'ko', target: 'en', label: 'ğŸ‡°ğŸ‡· í•œêµ­ì–´ -> ì˜ì–´' }
    ];

    // --- ì´ˆê¸°í™” ì‹¤í–‰ ---
    function updateZoom(newZoom) {
        currentZoom = Math.max(0.5, Math.min(2.0, newZoom));
        document.body.style.zoom = currentZoom;
        zoomLevelSpan.textContent = `${Math.round(currentZoom * 100)}%`;
    }
    function updateFontSize(newSize) {
        currentFontSize = Math.max(10, Math.min(24, newSize));
        document.documentElement.style.setProperty('--log-font-size', `${currentFontSize}px`);
        let levelText = "ê¸°ë³¸";
        if (currentFontSize > 14) levelText = `+${(currentFontSize - 14) / fontSizeStep}`;
        else if (currentFontSize < 14) levelText = `-${(14 - currentFontSize) / fontSizeStep}`;
        fontSizeLevelSpan.textContent = levelText;
        const entries = logDiv.querySelectorAll('.original, .translated');
        entries.forEach(el => el.style.fontSize = `${currentFontSize}px`);
    }
    function updateLangDisplay(sourceLang, targetLang) {
        const option = langOptions.find(opt => opt.source === sourceLang && opt.target === targetLang);
        langDisplayBtn.textContent = option ? option.label : `Error: ${sourceLang} -> ${targetLang}`;

        // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ì˜ í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
        langDropdownMenu.querySelectorAll('.lang-option').forEach(el => {
            el.classList.remove('active');
            if (el.dataset.source === sourceLang && el.dataset.target === targetLang) {
                el.classList.add('active');
            }
        });
    }
    function applyTheme(theme) {
        if (theme === 'light') {
            body.classList.add('light-mode');
            themeBtn.innerHTML = "ğŸŒ™ ë‹¤í¬ ëª¨ë“œ";
        } else {
            body.classList.remove('light-mode');
            themeBtn.innerHTML = "ğŸŒ ë¼ì´íŠ¸ ëª¨ë“œ";
        }
        localStorage.setItem('theme', theme);
        currentTheme = theme;
    }

    // â­ï¸ [ì‹ ê·œ] ì–¸ì–´ ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë Œë”ë§
    function renderLangOptions() {
        langDropdownMenu.innerHTML = '';
        langOptions.forEach(option => {
            const item = document.createElement('div');
            item.classList.add('lang-option');
            item.setAttribute('data-source', option.source);
            item.setAttribute('data-target', option.target);
            item.textContent = option.label;

            if (option.source === currentSourceLang && option.target === currentTargetLang) {
                item.classList.add('active');
            }

            item.addEventListener('click', (event) => {
                event.stopPropagation();

                const newSource = event.target.dataset.source;
                const newTarget = event.target.dataset.target;

                if (newSource === currentSourceLang && newTarget === currentTargetLang) {
                    langDropdownMenu.style.display = 'none';
                    return;
                }

                currentSourceLang = newSource;
                currentTargetLang = newTarget;
                localStorage.setItem('source_lang', newSource);
                localStorage.setItem('target_lang', newTarget);

                updateLangDisplay(newSource, newTarget);
                langDropdownMenu.style.display = 'none';

                socket.emit("change_language", {
                    language: newSource,
                    target: newTarget
                });
                console.log(`ğŸ§ ì–¸ì–´ ë³€ê²½ ìš”ì²­: ${newSource} -> ${newTarget}`);
                addSystemMessage(`ë²ˆì—­ ë°©í–¥ì„ ${option.label}ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`);
            });
            langDropdownMenu.appendChild(item);
        });
    }


    applyTheme(currentTheme);
    updateZoom(currentZoom);
    updateFontSize(currentFontSize);
    // â­ï¸ [ìˆ˜ì •] ì´ˆê¸° ì–¸ì–´ ì„¤ì • ë° ë Œë”ë§
    updateLangDisplay(currentSourceLang, currentTargetLang);
    document.addEventListener("DOMContentLoaded", () => {
        renderLangOptions(); // ì˜µì…˜ ë™ì  ìƒì„±
        addSystemMessage("ì„œë²„ ì¤€ë¹„ ì™„ë£Œ. 'Start Translation'ì„ ëˆŒëŸ¬ ì„¸ì…˜ì„ ì‹œì‘í•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ì„¸ìš”.");
    });
    // ---------------------

    // â­ï¸ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€ í—¬í¼ í•¨ìˆ˜
    function addSystemMessage(message) {
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("system-message");
        msgDiv.textContent = message;
        logDiv.appendChild(msgDiv);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    // â­ï¸ ë¡œê·¸ Clear (ì „ì²´ ì‚­ì œ) ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    clearLogBtn.addEventListener('click', () => {
        if (confirm("ì •ë§ë¡œ ëª¨ë“  ë¡œê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
            logs.length = 0;
            renderLogs(logDiv, logs, false);
            console.log("ğŸ”¥ ëª¨ë“  ë¡œê·¸ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            addSystemMessage("ë¡œê·¸ê°€ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    });

    // â­ï¸ [ìˆ˜ì •] ì„¸ì…˜ ì œì–´ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (Prompt íŒì—… ì‚¬ìš©)
    sessionControlBtn.addEventListener('click', () => {
        const currentText = sessionControlBtn.textContent;
        // ê¸°ì¡´ ê²€ìƒ‰ì°½ ê°’ì€ ë¬´ì‹œí•©ë‹ˆë‹¤.

        if (currentText.includes('Start')) {
            // â­ï¸ [ì‹ ê·œ] íŒì—…ì°½ìœ¼ë¡œ ì„¸ì…˜ ì´ë¦„ ì…ë ¥ë°›ê¸°
            const now = new Date();
            const defaultName = `Session_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;

            let newSessionId = prompt("ìƒˆë¡œ ì‹œì‘í•  ì„¸ì…˜ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", defaultName);

            if (newSessionId === null) return; // ì·¨ì†Œ ëˆ„ë¦„

            newSessionId = newSessionId.trim();

            if (!newSessionId) {
                alert("ì„¸ì…˜ ì´ë¦„ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }

            // (ì„ íƒ ì‚¬í•­) ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì„¸ì…˜ì¸ì§€ í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ë¯¸ë¦¬ í™•ì¸
            const isExisting = allSessions.some(s => s.session_id === newSessionId);
            if (isExisting) {
                if(!confirm(`'${newSessionId}'ì€(ëŠ”) ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì„¸ì…˜ì…ë‹ˆë‹¤.\ní•´ë‹¹ ì„¸ì…˜ì— ì´ì–´ì„œ ë…¹ìŒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
            }

            console.log(`ğŸš€ 'start_translation_session' ìš”ì²­ ì „ì†¡ (ID: ${newSessionId})`);
            addSystemMessage(`'${newSessionId}' ì„¸ì…˜ ì‹œì‘ ìš”ì²­ ì¤‘... (ì„œë²„ ì‘ë‹µ ëŒ€ê¸°)`);
            socket.emit("start_translation_session", {
                session_id: newSessionId
            });

        } else if (currentText.includes('End')) {
            if (confirm(`í˜„ì¬ ë²ˆì—­ ì„¸ì…˜ì„ ì¤‘ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                console.log("ğŸš€ 'stop_translation_session' ìš”ì²­ ì „ì†¡");
                addSystemMessage("ì„¸ì…˜ ì¤‘ì§€ ìš”ì²­ ì¤‘...");
                socket.emit("stop_translation_session", {});
            }
        }
    });

    // ----------------------------------------------------
    // âœ¨ ìœ í‹¸ë¦¬í‹° ë©”ë‰´ ë‚´ë¶€ ê¸°ëŠ¥ ë¦¬ìŠ¤ë„ˆ (stopPropagation í¬í•¨)
    // ----------------------------------------------------

    // â­ï¸ ìœ í‹¸ë¦¬í‹° ë©”ë‰´ í† ê¸€ ê¸°ëŠ¥
    utilityMenuToggle.addEventListener('click', (event) => {
        event.stopPropagation();
        const isHidden = utilityDropdownMenu.style.display === 'none' || utilityDropdownMenu.style.display === '';
        utilityDropdownMenu.style.display = isHidden ? 'flex' : 'none';

        // ìœ í‹¸ë¦¬í‹° ë©”ë‰´ ì—´ ë•Œ ì–¸ì–´ ë“œë¡­ë‹¤ìš´ì€ ë‹«ê¸°
        if (isHidden) langDropdownMenu.style.display = 'none';
    });

    // â­ï¸ ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', (event) => {
        if (utilityDropdownMenu.style.display === 'flex' &&
            !utilityDropdownMenu.contains(event.target) &&
            event.target !== utilityMenuToggle) {

            utilityDropdownMenu.style.display = 'none';
        }

        // ì–¸ì–´ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ë„ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        const langContainer = document.getElementById("lang-select-container");
        if (langDropdownMenu.style.display === 'flex' && !langContainer.contains(event.target)) {
            langDropdownMenu.style.display = 'none';
        }
    });

    // â­ï¸ [ì‹ ê·œ] ì–¸ì–´ ë“œë¡­ë‹¤ìš´ í† ê¸€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    langDisplayBtn.addEventListener("click", (event) => {
        event.stopPropagation();
        const isHidden = langDropdownMenu.style.display === 'none' || langDropdownMenu.style.display === '';
        langDropdownMenu.style.display = isHidden ? 'flex' : 'none';
    });


    // â­ï¸ í™”ì ë¶„ì„ ë²„íŠ¼ í´ë¦­ ë¦¬ìŠ¤ë„ˆ (stopPropagation ì¶”ê°€)
    diarizeBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        utilityDropdownMenu.style.display = 'none';
        // í™”ì ë¶„ì„ì€ í˜„ì¬ ê²€ìƒ‰ì°½ì— ì„ íƒëœ ì„¸ì…˜ì„ ê¸°ì¤€ìœ¼ë¡œ í•©ë‹ˆë‹¤.
        const selectedId = sessionSearchInput.value.trim();

        if (!selectedId || sessionControlBtn.textContent.includes('End')) {
             if (sessionControlBtn.textContent.includes('End')) {
                alert("ì‹¤ì‹œê°„ ë²ˆì—­ì„ ë¨¼ì € ì¤‘ì§€í•´ì•¼ ë¶„ì„ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
             } else {
                 alert("ë¨¼ì € ë¶„ì„í•  ì„¸ì…˜ì„ ê²€ìƒ‰í•˜ì—¬ ë¡œë“œí•´ì£¼ì„¸ìš”.");
             }
            return;
        }

        if (confirm(`[${selectedId}] ì„¸ì…˜ì˜ í™”ì ë¶„ë¦¬ ë¶„ì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            logs.length = 0;
            renderLogs(logDiv, logs, false);
            addSystemMessage(`[ì„¸ì…˜ '${selectedId}' í™”ì ë¶„ë¦¬ ë¶„ì„ ì¤‘...]`);
            socket.emit("request_diarization", { session_id: selectedId });
        }
    });

    // âŒ ì„¸ì…˜ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¨

    // â­ï¸ [ìˆ˜ì •] ìš”ì•½ ë²„íŠ¼ í´ë¦­ ë¦¬ìŠ¤ë„ˆ (ê¸¸ì´ ì „ì†¡ ì¶”ê°€)
    toggleBtn.addEventListener("click", (event) => {
        event.stopPropagation();
        utilityDropdownMenu.style.display = 'none';
        const selectedId = sessionSearchInput.value.trim();

        // â­ï¸ ì„ íƒëœ ìš”ì•½ ê¸¸ì´ ê°€ì ¸ì˜¤ê¸°
        const lengthSelect = document.getElementById("summary-length-select");
        const selectedLength = lengthSelect.value;

        if (!selectedId) {
            alert("ë¨¼ì € 'ìš”ì•½'í•  ì„¸ì…˜ì„ ê²€ìƒ‰í•˜ì—¬ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        openSummaryWindow(selectedId);
        // â­ï¸ ê¸¸ì´ íŒŒë¼ë¯¸í„° í•¨ê»˜ ì „ì†¡
        socket.emit("request_specific_summary", {
            session_id: selectedId,
            length: selectedLength
        });
    });


    // â­ï¸ í…Œë§ˆ í† ê¸€ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ (stopPropagation ì¶”ê°€)
    themeBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
    });

    // â­ï¸ ì¤Œ/í°íŠ¸ ë¦¬ìŠ¤ë„ˆ (stopPropagation ì¶”ê°€)
    zoomInBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        updateZoom(currentZoom + zoomStep);
    });
    zoomOutBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        updateZoom(currentZoom - zoomStep);
    });
    fontIncreaseBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        updateFontSize(currentFontSize + fontSizeStep);
    });
    fontDecreaseBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        updateFontSize(currentFontSize - fontSizeStep);
    });

    // ----------------------------------------------------
    // âœ¨ ê²€ìƒ‰ ê°€ëŠ¥í•œ ì„¸ì…˜ ë“œë¡­ë‹¤ìš´ ë¡œì§ (ìƒì„± ê¸°ëŠ¥ ì œê±°)
    // ----------------------------------------------------

    // â­ï¸ [ìˆ˜ì •] ì„¸ì…˜ ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§ í•¨ìˆ˜ (ì‚­ì œ ë²„íŠ¼: X í‘œì‹œ)
    function renderSessionResults(filterText = '') {
        sessionSearchResults.innerHTML = '';
        const lowerFilter = filterText.toLowerCase();

        const filteredSessions = allSessions.filter(session =>
            session.session_id.toLowerCase().includes(lowerFilter)
        );

        if (filteredSessions.length === 0) {
            const noResult = document.createElement('div');
            noResult.classList.add('session-item');
            noResult.textContent = filterText ? "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤." : "ì„¸ì…˜ ëª©ë¡ ì—†ìŒ";
            noResult.style.cursor = "default";
            sessionSearchResults.appendChild(noResult);
            return;
        }

        filteredSessions.forEach((session, index) => {
            const item = document.createElement('div');
            item.classList.add('session-item');
            item.setAttribute('data-id', session.session_id);
            item.setAttribute('data-index', index);

            // â­ï¸ ìŠ¤íƒ€ì¼: í…ìŠ¤íŠ¸ì™€ ë²„íŠ¼ì„ ì–‘ì˜†ìœ¼ë¡œ ë°°ì¹˜ (Flexbox)
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.style.alignItems = 'center';

            const startTime = session.start_time ? new Date(session.start_time).toLocaleString('ko-KR') : 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
            const duration = session.duration ? ` (ì•½ ${session.duration}ì´ˆ)` : '';

            // 1. í…ìŠ¤íŠ¸ ì •ë³´ ì˜ì—­ (ì¢Œì¸¡)
            const infoDiv = document.createElement('div');
            infoDiv.innerHTML = `
                <div>${session.session_id}</div>
                <span class="session-timeline">${startTime}${duration}</span>
            `;

            // 2. ì‚­ì œ ë²„íŠ¼ ìƒì„± (ìš°ì¸¡) - X í‘œì‹œë¡œ ë³€ê²½
            const delBtn = document.createElement('button');
            delBtn.innerHTML = '&times;'; // â­ï¸ X í‘œì‹œ (HTML ì—”í‹°í‹°)
            delBtn.title = 'ì´ ì„¸ì…˜ ì˜êµ¬ ì‚­ì œ';
            delBtn.style.marginLeft = '10px';
            delBtn.style.background = 'transparent';
            delBtn.style.border = 'none';
            delBtn.style.cursor = 'pointer';
            delBtn.style.fontSize = '1.5em'; // â­ï¸ í¬ê¸° í‚¤ì›€
            delBtn.style.fontWeight = 'bold'; // â­ï¸ êµµê²Œ
            delBtn.style.lineHeight = '1';
            delBtn.style.color = '#ff6b6b'; // ë¹¨ê°„ìƒ‰ ê³„ì—´
            delBtn.style.padding = '0 5px';
            delBtn.style.borderRadius = '4px';
            delBtn.style.transition = 'color 0.2s, background 0.2s';

            // ì‚­ì œ ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼
            delBtn.onmouseover = () => {
                delBtn.style.background = 'rgba(255, 0, 0, 0.1)';
                delBtn.style.color = '#ff4757';
            };
            delBtn.onmouseout = () => {
                delBtn.style.background = 'transparent';
                delBtn.style.color = '#ff6b6b';
            };

            // â­ï¸ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ëª©ë¡ í´ë¦­ ë°©ì§€ í¬í•¨)
            delBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // ë¶€ëª¨ ìš”ì†Œ(ì„¸ì…˜ ì„ íƒ)ë¡œ í´ë¦­ ì´ë²¤íŠ¸ê°€ ì „íŒŒë˜ì§€ ì•Šë„ë¡ ë§‰ìŒ

                if (confirm(`ì •ë§ë¡œ '${session.session_id}' ì„¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)`)) {
                    console.log(`ğŸš€ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚­ì œ ìš”ì²­: ${session.session_id}`);
                    socket.emit("request_delete_session", { session_id: session.session_id });
                }
            });

            // ìš”ì†Œ ì¡°ë¦½
            item.appendChild(infoDiv);
            item.appendChild(delBtn);

            // ê¸°ì¡´ ì•„ì´í…œ í´ë¦­ ì´ë²¤íŠ¸ (ì„¸ì…˜ ì„ íƒ)
            item.addEventListener('click', (e) => {
                selectSession(session.session_id);
                sessionSearchResults.style.display = 'none';
            });

            sessionSearchResults.appendChild(item);
        });

        highlightedIndex = -1;
    }

    // â­ï¸ [ìˆ˜ì •] ì„¸ì…˜ ì„ íƒ ì²˜ë¦¬ í•¨ìˆ˜
    function selectSession(sessionId) {
        sessionSearchInput.value = sessionId;
        selectedSessionId = sessionId;
        sessionSearchResults.style.display = 'none';

        // ë‹¨ìˆœíˆ ì„ íƒ ë° ë¡œë“œ ìš”ì²­ë§Œ ìˆ˜í–‰
        addSystemMessage(`ì„¸ì…˜ '${sessionId}'ì„(ë¥¼) ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.`);
        socket.emit("request_load_session", { session_id: sessionId });
    }

    // ì…ë ¥ í•„ë“œ ì…ë ¥ ì´ë²¤íŠ¸ (ê²€ìƒ‰ ê¸°ëŠ¥)
    sessionSearchInput.addEventListener('input', () => {
        const filter = sessionSearchInput.value.trim();
        renderSessionResults(filter);
        sessionSearchResults.style.display = 'block';
    });

    // ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ì‹œ (ë“œë¡­ë‹¤ìš´ ì—´ê¸°)
    sessionSearchInput.addEventListener('focus', () => {
        renderSessionResults(sessionSearchInput.value.trim());
        sessionSearchResults.style.display = 'block';
    });

    // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    document.addEventListener('click', (event) => {
        const container = document.getElementById("session-search-container");
        if (!container.contains(event.target)) {
            sessionSearchResults.style.display = 'none';
        }
    });

    // â­ï¸ í‚¤ë³´ë“œ íƒìƒ‰ ê¸°ëŠ¥
    sessionSearchInput.addEventListener('keydown', (e) => {
        const results = Array.from(sessionSearchResults.querySelectorAll('.session-item'));
        // ê²°ê³¼ê°€ ì—†ê±°ë‚˜ í´ë¦­ ë¶ˆê°€ëŠ¥í•œ ìƒíƒœë©´ ë¦¬í„´
        if (results.length === 0 || results[0].style.cursor === "default") return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            highlightedIndex = (highlightedIndex + 1) % results.length;
            updateHighlight(results);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            highlightedIndex = (highlightedIndex - 1 + results.length) % results.length;
            updateHighlight(results);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (highlightedIndex !== -1) {
                // í•˜ì´ë¼ì´íŠ¸ ëœ í•­ëª© ì„ íƒ
                results[highlightedIndex].click();
            }
        }
    });

    // í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸ í—¬í¼
    function updateHighlight(results) {
        results.forEach((item, index) => {
            item.classList.toggle('highlighted', index === highlightedIndex);
            if (index === highlightedIndex) {
                item.scrollIntoView({ block: 'nearest' });
            }
        });
        if (highlightedIndex !== -1) {
            sessionSearchInput.value = results[highlightedIndex].getAttribute('data-id') || results[highlightedIndex].textContent;
        }
    }


    // ----------------------------------------------------
    // âœ¨ Socket.IO ì—°ë™ ë¡œì§
    // ----------------------------------------------------

    // "connect" í•¸ë“¤ëŸ¬ì— ì„¸ì…˜ ëª©ë¡ ìš”ì²­ ì¶”ê°€
    socket.on("connect", () => {
        console.log("âœ… ì„œë²„ ì—°ê²° ì„±ê³µ");
        console.log("ğŸš€ 'request_session_list' ìš”ì²­ ì „ì†¡");
        socket.emit("request_session_list", {});
        // ì´ˆê¸° ì–¸ì–´ ì„¤ì • ì „ì†¡
        socket.emit("change_language", { language: currentSourceLang, target: currentTargetLang });
    });

    // ì‹¤ì‹œê°„ ë²ˆì—­ ë¡œê·¸ ìˆ˜ì‹ 
    socket.on("partial_translation", data => {
        logs.push(data);
        renderLogs(logDiv, logs, true);
    });

    // ê¸°ì¡´ ì„¸ì…˜ ë¡œê·¸ ë¡œë“œ
    socket.on("session_log_loaded", data => {
        console.log(`âœ… ì„¸ì…˜ ë¡œê·¸ ë¡œë“œ ì™„ë£Œ: ${data.session_id}`);
        logs.length = 0;
        logs.push(...data.logs);
        renderLogs(logDiv, logs, true);
        addSystemMessage(`ì„¸ì…˜ '${data.session_id}'ì˜ ë¡œê·¸ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`);
    });


    // ì„œë²„ì—ì„œ ìš”ì•½ ë°ì´í„° ìˆ˜ì‹ 
    socket.on("summary_data_updated", data => {
        if (summaryWindow && !summaryWindow.closed) {
            const summaryTextDiv = summaryWindow.document.getElementById('summary-text');
            if (summaryTextDiv) summaryTextDiv.textContent = data.summary;
            const sessionInfoDiv = summaryWindow.document.getElementById('session-info');
            if(sessionInfoDiv) sessionInfoDiv.textContent = `ì„¸ì…˜: ${data.current_session_id}`;
        }
    });

    // í™”ì ë¶„ë¦¬ ê²°ê³¼ ìˆ˜ì‹ 
    socket.on("diarization_result", data => {
        console.log(`âœ… í™”ì ë¶„ë¦¬ ê²°ê³¼ ìˆ˜ì‹ : ${data.session_id}`);
        logDiv.innerHTML = "";
        if(data.session_id) { addSystemMessage(`--- '${data.session_id}' í™”ì ë¶„ë¦¬ ì™„ë£Œ ---`); }
        const lines = data.result_text.split('\n');
        lines.forEach(line => {
            if (line.startsWith('**SPEAKER_')) {
                const parts = line.split('**:');
                const speaker = parts[0].replace(/\*\*/g, '');
                const originalText = parts[1] ? parts[1].trim() : "(ë‚´ìš© ì—†ìŒ)";
                const entry = document.createElement("div");
                entry.classList.add("log-entry");
                const speakerDiv = document.createElement("div");
                speakerDiv.classList.add("timestamp");
                speakerDiv.textContent = speaker;
                const originalContainer = document.createElement("div");
                originalContainer.classList.add("original-container");
                const originalDiv = document.createElement("div");
                originalDiv.classList.add("original");
                originalDiv.textContent = originalText;
                originalDiv.style.fontSize = `${currentFontSize}px`;
                originalContainer.appendChild(originalDiv);
                originalContainer.appendChild(speakerDiv);
                entry.appendChild(originalContainer);
                logDiv.appendChild(entry);
                setTimeout(() => entry.classList.add("show"), 10);
            } else if (line.startsWith('**_SAME_SPEAKER_**')) {
                const parts = line.split('**:');
                const originalText = parts[1] ? parts[1].trim() : "(ë‚´ìš© ì—†ìŒ)";
                const entry = document.createElement("div");
                entry.classList.add("log-entry");
                const originalContainer = document.createElement("div");
                originalContainer.classList.add("original-container");
                const originalDiv = document.createElement("div");
                originalDiv.classList.add("original");
                originalDiv.textContent = originalText;
                originalDiv.style.fontSize = `${currentFontSize}px`;
                originalContainer.appendChild(originalDiv);
                entry.appendChild(originalContainer);
                logDiv.appendChild(entry);
                setTimeout(() => entry.classList.add("show"), 10);
            } else if (line.startsWith('*(') && line.endsWith(')*')) {
                const translatedText = line.substring(2, line.length-2);
                const translatedContainer = document.createElement("div");
                translatedContainer.classList.add("translated-container");
                const translatedDiv = document.createElement("div");
                translatedDiv.classList.add("translated");
                translatedDiv.textContent = translatedText;
                translatedDiv.style.fontSize = `${currentFontSize}px`;
                translatedContainer.appendChild(translatedDiv);
                const lastEntry = logDiv.lastChild;
                if(lastEntry && lastEntry.classList.contains('log-entry')) {
                    lastEntry.appendChild(translatedContainer);
                }
            }
        });
        logDiv.scrollTop = 0;
    });

    // ë©”ì¸ í˜ì´ì§€ ì„¸ì…˜ ëª©ë¡ ì—…ë°ì´íŠ¸ (íƒ€ì„ë¼ì¸ í¬í•¨)
    socket.on("session_list_updated", data => {
        console.log("âœ… ì„¸ì…˜ ëª©ë¡ ìˆ˜ì‹ ");

        allSessions = data.all_sessions.map(session_id => {
            const sessionData = data.session_details ? data.session_details.find(d => d.session_id === session_id) : {};
            return {
                session_id: session_id,
                start_time: sessionData?.start_time || new Date().toISOString(),
                duration: sessionData?.duration || 0
            };
        });

        // â­ï¸ [ìˆ˜ì •] ìë™ ì„ íƒ ë¡œì§ ì œê±° -> ë¹ˆ ì¹¸ìœ¼ë¡œ ì´ˆê¸°í™”
        sessionSearchInput.value = "";
        selectedSessionId = "";

        // ì „ì²´ ëª©ë¡ ë Œë”ë§ (ë“œë¡­ë‹¤ìš´ ì¤€ë¹„)
        renderSessionResults("");
    });

    // ì„œë²„ë¡œë¶€í„° ìƒˆ ì„¸ì…˜ì´ ì‹œì‘ë˜ì—ˆìŒì„ í™•ì¸
    socket.on("new_session_started", data => {
        logs.length = 0;
        renderLogs(logDiv, logs, false);
        sessionControlBtn.textContent = "End Session";
        sessionControlBtn.classList.add("session-active");
        sessionSearchInput.value = data.session_id;
        addSystemMessage(`--- ìƒˆ ì„¸ì…˜ '${data.session_id}'ì´(ê°€) ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ---`);
        socket.emit("request_session_list", {});
    });

    // â­ï¸ ì„œë²„ë¡œë¶€í„° ì„¸ì…˜ì´ ì¤‘ì§€ë˜ì—ˆìŒì„ í™•ì¸ (ìƒˆë¡œê³ ì¹¨)
    socket.on("session_stopped", data => {
        console.log(`âœ… ì„œë²„ê°€ ì„¸ì…˜ ì¤‘ì§€ í™•ì¸: ${data.message}`);

        sessionControlBtn.textContent = "Start Translation";
        sessionControlBtn.classList.remove("session-active");
        addSystemMessage(`--- ${data.message} ---`);

        setTimeout(() => {
            console.log("í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...");
            window.location.reload();
        }, 1000);
    });

    // ê¸°íƒ€ ì˜¤ë¥˜/ë³€ê²½ ì´ë²¤íŠ¸
    socket.on("language_changed", data => {
        console.log(`âœ… ì„œë²„ê°€ ì–¸ì–´ ë³€ê²½ í™•ì¸: ${data.language} -> ${data.target}`);
        currentSourceLang = data.language;
        currentTargetLang = data.target;
        localStorage.setItem('source_lang', data.language);
        localStorage.setItem('target_lang', data.target);
        updateLangDisplay(data.language, data.target);
    });
    socket.on("session_start_failed", data => { console.error(`âŒ ì„¸ì…˜ ì‹œì‘ ì‹¤íŒ¨: ${data.error}`); addSystemMessage(`[ì˜¤ë¥˜] ì„¸ì…˜ ì‹œì‘ ì‹¤íŒ¨: ${data.error}`); });
    socket.on("diarization_failed", data => { console.error(`âŒ í™”ì ë¶„ë¦¬ ì‹¤íŒ¨: ${data.error}`); logDiv.innerHTML = ""; addSystemMessage(`[ì˜¤ë¥˜] í™”ì ë¶„ë¦¬ ì‹¤íŒ¨: ${data.error}`); addSystemMessage(`--- ì„¸ì…˜ '${data.session_id}' ë¶„ì„ ì‹¤íŒ¨ ---`); });
    socket.on("session_delete_success", data => { console.log(`âœ… ì„¸ì…˜ ì‚­ì œ ì„±ê³µ: ${data.session_id}`); addSystemMessage(`ì„¸ì…˜ '${data.session_id}'ì´(ê°€) ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`); socket.emit("request_session_list", {}); });


    // â­ï¸ ë¡œê·¸ ë Œë”ë§ í•¨ìˆ˜ (íƒ€ì„ë¼ì¸ í¬í•¨)
    function renderLogs(container, dataLogs, scrollToBottom=false){
        container.innerHTML = "";
        dataLogs.forEach(data => {
            const entry = document.createElement("div");
            entry.classList.add("log-entry");

            // --- ì›ë³¸ í…ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ (ì¢Œì¸¡) ---
            const originalContainer = document.createElement("div");
            originalContainer.classList.add("original-container");

            const originalDiv = document.createElement("div");
            originalDiv.classList.add("original");
            originalDiv.textContent = data.original_text || data.original;
            originalDiv.style.fontSize = `${currentFontSize}px`;

            const timeDivOriginal = document.createElement("div");
            timeDivOriginal.classList.add("timestamp");
            timeDivOriginal.textContent = data.time || "";

            originalContainer.appendChild(originalDiv);
            originalContainer.appendChild(timeDivOriginal);
            entry.appendChild(originalContainer);

            // --- ë²ˆì—­ í…ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ (ìš°ì¸¡) ---
            if (data.translated_text || data.translated) {
                const translatedContainer = document.createElement("div");
                translatedContainer.classList.add("translated-container");

                const translatedDiv = document.createElement("div");
                translatedDiv.classList.add("translated");
                translatedDiv.textContent = data.translated_text || data.translated;
                translatedDiv.style.fontSize = `${currentFontSize}px`;

                const timeDivTranslated = document.createElement("div");
                timeDivTranslated.classList.add("timestamp");
                timeDivTranslated.textContent = data.time || "";

                translatedContainer.appendChild(timeDivTranslated);
                translatedContainer.appendChild(translatedDiv);
                entry.appendChild(translatedContainer);
            }

            container.appendChild(entry);
            setTimeout(() => entry.classList.add("show"), 10);
        });

        if(scrollToBottom) {
            container.scrollTop = container.scrollHeight;
        }
    }

    // íŒì—… ì°½ ì—´ê¸° í•¨ìˆ˜
    function openSummaryWindow(sessionId) {
        if (summaryWindow && !summaryWindow.closed) { summaryWindow.focus(); socket.emit("request_specific_summary", { session_id: sessionId }); return; }
        const windowFeatures = 'width=500,height=600,scrollbars=yes,resizable=yes,top=100,left=100';
        summaryWindow = window.open('', 'SummaryPopup', windowFeatures);

        if (summaryWindow) {
            const isLight = currentTheme === 'light';
            const popupBg = isLight ? '#f4f4f9' : '#222';
            const popupText = isLight ? '#333' : '#fff';
            const popupHighlight = isLight ? '#007bff' : '#1dd1a1';
            const popupBorder = isLight ? '#ddd' : '#555';
            const popupSummaryBg = isLight ? '#f9f9f9' : '#2a2a2a';

            const popupHTML = `
                <!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>ë²ˆì—­ ìš”ì•½</title>
                <style>
                    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: ${popupBg}; color: ${popupText}; line-height: 1.6; transition: background 0.3s, color 0.3s; }
                    h1 { text-align: center; color: ${popupHighlight}; margin-bottom: 5px; font-size: 1.5em; }
                    #session-info { text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 0.9em; color: ${isLight ? '#555' : '#aaa'}; }
                    #summary-text { white-space: pre-wrap; border: 1px solid ${popupBorder}; padding: 15px; border-radius: 8px; background: ${popupSummaryBg}; min-height: 300px; }
                </style>
                </head><body>
                    <h1>ë²ˆì—­ ìš”ì•½</h1>
                    <div id="session-info">ì„¸ì…˜: ${sessionId}</div>
                    <div id="summary-text">[ìš”ì•½ ìƒì„± ì¤‘...]</div>
                </body></html>
            `;
            summaryWindow.document.write(popupHTML);
            summaryWindow.document.close();
        } else {
            alert("íŒì—… ì°½ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
    }

</script>
</body>
</html>