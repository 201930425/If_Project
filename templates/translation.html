<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì‹¤ì‹œê°„ ë²ˆì—­ - ì„¸ì…˜ ë·° (ë³„ë„ íŒì—… ì°½)</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        margin:0;
        padding:15px;
        display:flex;
        flex-direction:column;
        height:100vh;
        /* ê¸°ë³¸: ë‹¤í¬ ëª¨ë“œ */
        background: var(--bg-color, #222);
        color: var(--text-color, #fff);
        transition: background 0.3s, color 0.3s;
    }

    /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ: ë²„íŠ¼ë“¤ì„ ì˜¤ë¥¸ìª½ ìƒë‹¨ì— ë°°ì¹˜ */
    #button-container {
        display: flex;
        gap: 10px;
        align-self: flex-end;
        margin-bottom: 15px;
        z-index: 10;
        align-items: center; /* ìƒˆë¡œ ì¶”ê°€ëœ ì…€ë ‰íŠ¸ ë°•ìŠ¤ì™€ ë†’ì´ ë§ì¶”ê¸° */
    }

    #language-select {
        padding: 8px 10px;
        cursor: pointer;
        background: var(--button-bg, #1dd1a1);
        border: none;
        border-radius: 20px;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        transition: background 0.3s, color 0.3s;
        color: var(--text-color);
        /* í°íŠ¸ í¬ê¸°ë¥¼ ë²„íŠ¼ê³¼ ìœ ì‚¬í•˜ê²Œ ì¡°ì • */
        font-size: 14px;
        appearance: none; /* ê¸°ë³¸ ì…€ë ‰íŠ¸ ìŠ¤íƒ€ì¼ ì œê±° */
        -webkit-appearance: none;
        -moz-appearance: none;
    }
    #language-select:hover { background: var(--button-hover-bg, #10ac84); }

    #toggle-summary, #toggle-theme {
        padding:8px 18px;
        cursor:pointer;
        background: var(--button-bg, #1dd1a1);
        border:none;
        border-radius:20px;
        font-weight:bold;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        transition: background 0.3s, color 0.3s;
        color: var(--text-color);
    }
    #toggle-summary:hover, #toggle-theme:hover { background: var(--button-hover-bg, #10ac84); }

    /* ë¼ì´íŠ¸ ëª¨ë“œ ë³€ìˆ˜ ì •ì˜ */
    body.light-mode {
        --bg-color: #f4f4f9;
        --text-color: #333;
        --log-bg: rgba(0,0,0,0.05);
        --original-bg: rgba(0,0,0,0.1);
        --original-text: #333;
        --translated-bg: #007bff;
        --translated-text: #fff;
        --timestamp-color: #007bff;
        --button-bg: #007bff;
        --button-hover-bg: #0056b3;
    }

    /* ë‹¤í¬ ëª¨ë“œ ë³€ìˆ˜ ì •ì˜ (ê¸°ì¡´ ê°’) */
    body {
        --bg-color: #222;
        --text-color: #fff;
        --log-bg: rgba(255,255,255,0.05);
        --original-bg: rgba(255,255,255,0.2);
        --original-text: #fff;
        --translated-bg: rgba(255,255,255,0.8);
        --translated-text: #333;
        --timestamp-color: #ffd700;
        --button-bg: #1dd1a1;
        --button-hover-bg: #10ac84;
    }

    /* ì½˜í…ì¸  ì˜ì—­ */
    #content-container {
        flex: 1;
        display: flex;
        min-height: 0;
    }

    #log {
        flex: 1;
        overflow-y:auto;
        display:flex;
        flex-direction:column;
        gap:12px;
        padding:12px;
        border-radius:15px;
        background: var(--log-bg);
        transition: background 0.3s;
    }

    /* ë¡œê·¸ í•­ëª© ìŠ¤íƒ€ì¼ (ìœ ì§€) */
    .log-entry {
        display:flex;
        flex-direction:column;
        gap:6px;
        opacity:0;
        transform: translateY(10px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .log-entry.show {
        opacity:1;
        transform: translateY(0);
    }
    .original, .translated {
        max-width:70%;
        padding:10px 14px;
        border-radius:22px;
        word-wrap:break-word;
        font-size:14px;
        transition: background 0.3s, color 0.3s;
    }
    .original {
        background: var(--original-bg);
        color: var(--original-text);
        align-self:flex-start;
    }
    .translated {
        background: var(--translated-bg);
        color: var(--translated-text);
        align-self:flex-end;
    }
    .timestamp {
        font-size:0.75em;
        color: var(--timestamp-color);
        text-align:center;
        transition: color 0.3s;
    }

    /* íŒì—… ê´€ë ¨ ìš”ì†ŒëŠ” ì œê±°í•˜ê±°ë‚˜ ìˆ¨ê¹€ ì²˜ë¦¬ */
    #summary-log, #summary-content, #summary-close {
        display: none;
    }

</style>
</head>
<body>
    <div id="button-container">
        <select id="language-select">
            <option value="en">ğŸ‡ºğŸ‡¸ ì˜ì–´ ë²ˆì—­</option>
            <option value="ja">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ ë²ˆì—­</option>
        </select>

        <button id="toggle-theme">ğŸŒ ë¼ì´íŠ¸ ëª¨ë“œ</button>
        <button id="toggle-summary">ìš”ì•½ ìƒˆ ì°½ ì—´ê¸°</button>
    </div>

    <div id="content-container">
        <div id="log"></div>

        </div>

    <script>
    const socket = io();
    const body = document.body;
    const logDiv = document.getElementById("log");
    const toggleBtn = document.getElementById("toggle-summary");
    const themeBtn = document.getElementById("toggle-theme");
    // ğŸ’¡ ì–¸ì–´ ì…€ë ‰íŠ¸ ìš”ì†Œ ì¶”ê°€
    const languageSelect = document.getElementById("language-select");
    const logs = [];

    // íŒì—… ì°½ ê°ì²´ë¥¼ ì €ì¥í•  ë³€ìˆ˜
    let summaryWindow = null;

    // ğŸ’¡ ì´ˆê¸° í…Œë§ˆ ë° ì–¸ì–´ ì„¤ì • (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™•ì¸)
    let currentTheme = localStorage.getItem('theme') || 'dark';
    // ê¸°ë³¸ ë²ˆì—­ ì–¸ì–´ë¥¼ 'en'ìœ¼ë¡œ ì„¤ì •
    let currentLanguage = localStorage.getItem('translation_lang') || 'en';


    function applyTheme(theme) {
        if (theme === 'light') {
            body.classList.add('light-mode');
            themeBtn.innerHTML = "ğŸŒ™ ë‹¤í¬ ëª¨ë“œ";
        } else {
            body.classList.remove('light-mode');
            themeBtn.innerHTML = "ğŸŒ ë¼ì´íŠ¸ ëª¨ë“œ";
        }
        localStorage.setItem('theme', theme);
        currentTheme = theme;
    }

    // ğŸ’¡ ì–¸ì–´ ì ìš© í•¨ìˆ˜
    function applyLanguage(lang) {
        localStorage.setItem('translation_lang', lang);
        currentLanguage = lang;
        languageSelect.value = lang; // UIì— ë°˜ì˜

        // ğŸš¨ ì¤‘ìš”: ì–¸ì–´ê°€ ë³€ê²½ë˜ë©´ ì„œë²„ì— ìƒˆ ì–¸ì–´ë¡œ ë²ˆì—­ì„ ìš”ì²­í•˜ë„ë¡ ì‹ í˜¸ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
        // ì´ ì˜ˆì‹œì—ì„œëŠ” "change_translation_target"ì´ë¼ëŠ” ì´ë²¤íŠ¸ë¥¼ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
        // ì„œë²„ ì¸¡ì—ì„œ ì´ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ì—¬ ì‹¤ì‹œê°„ ë²ˆì—­ ëŒ€ìƒ ì–¸ì–´ë¥¼ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
        socket.emit("change_translation_target", { target_lang: lang });

        // ë¡œê·¸ë¥¼ ë¹„ì›Œì„œ ìƒˆë¡œìš´ ì–¸ì–´ì˜ ë²ˆì—­ë§Œ í‘œì‹œí•˜ë„ë¡ ì¤€ë¹„í•©ë‹ˆë‹¤.
        logs.length = 0;
        renderLogs(logDiv, logs, false);

        console.log(`âœ… ë²ˆì—­ ëŒ€ìƒ ì–¸ì–´ ë³€ê²½ ìš”ì²­: ${lang}`);
    }


    // í˜ì´ì§€ ë¡œë“œ ì‹œ í…Œë§ˆ ë° ì–¸ì–´ ì ìš©
    applyTheme(currentTheme);
    applyLanguage(currentLanguage); // ì–¸ì–´ ìƒíƒœ ì ìš© ë° ì„œë²„ì— ìš”ì²­

    // ğŸ’¡ í…Œë§ˆ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    themeBtn.addEventListener('click', () => {
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
    });

    // ğŸ’¡ ì–¸ì–´ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    languageSelect.addEventListener('change', (e) => {
        applyLanguage(e.target.value);
    });


    // íŒì—… ì°½ ì—´ê¸° ë° ë‚´ìš© ì—…ë°ì´íŠ¸ ë¡œì§
    function openSummaryWindow(summaryText = "[ìš”ì•½ ìƒì„± ì¤‘...]") {
        if (summaryWindow && !summaryWindow.closed) {
            summaryWindow.focus();
            updateSummaryWindowContent(summaryText);
            return;
        }

        const windowFeatures = 'width=500,height=600,scrollbars=yes,resizable=yes,top=100,left=100';
        summaryWindow = window.open('', 'SummaryPopup', windowFeatures);

        if (summaryWindow) {
            // ìƒˆ ì°½ì˜ HTML êµ¬ì¡° ìƒì„± (í…Œë§ˆ ë³€ìˆ˜ ìœ ì§€)
            const popupHTML = `
                <!DOCTYPE html>
                <html lang="ko">
                <head>
                    <meta charset="UTF-8">
                    <title>íšŒì˜ ìš”ì•½</title>
                    <style>
                        body {
                            font-family: 'Segoe UI', Arial, sans-serif;
                            margin: 0;
                            padding: 20px;
                            background: ${currentTheme === 'light' ? '#fff' : '#333'};
                            color: ${currentTheme === 'light' ? '#333' : '#fff'};
                            line-height: 1.6;
                            transition: background 0.3s, color 0.3s;
                        }
                        h1 {
                            text-align: center;
                            color: ${currentTheme === 'light' ? '#007bff' : '#1dd1a1'};
                            margin-bottom: 20px;
                            font-size: 1.5em;
                        }
                        #summary-text {
                            white-space: pre-wrap;
                            border: 1px solid ${currentTheme === 'light' ? '#ddd' : '#555'};
                            padding: 15px;
                            border-radius: 8px;
                            background: ${currentTheme === 'light' ? '#f9f9f9' : '#2a2a2a'};
                        }
                    </style>
                </head>
                <body>
                    <h1>íšŒì˜ ìš”ì•½</h1>
                    <div id="summary-text">${summaryText}</div>
                </body>
                </html>
            `;

            summaryWindow.document.write(popupHTML);
            summaryWindow.document.close();

            // ğŸš¨ ì„œë²„ì— ìš”ì•½ ìš”ì²­ ë³´ë‚´ê¸° (ì„¸ì…˜ ID ëŒ€ì‹  í˜„ì¬ ë²ˆì—­ ì–¸ì–´ë„ í•¨ê»˜ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)
            socket.emit("request_summary", { target_lang: currentLanguage });
        } else {
            alert("íŒì—… ì°½ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
    }

    // ìƒˆ ì°½ì˜ ë‚´ìš©ë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function updateSummaryWindowContent(summary) {
        if (summaryWindow && !summaryWindow.closed) {
            const summaryTextDiv = summaryWindow.document.getElementById('summary-text');
            if (summaryTextDiv) {
                summaryTextDiv.textContent = summary;
            }
        }
    }


    toggleBtn.addEventListener("click", () => {
        openSummaryWindow("[ìš”ì•½ ìƒì„± ì¤‘...]");
    });

    // ----------------------------------------------------
    // âœ¨ Socket.IO ì—°ë™ ë¡œì§
    // ----------------------------------------------------

    socket.on("connect", () => console.log("âœ… ì„œë²„ ì—°ê²° ì„±ê³µ"));

    // 1. ì‹¤ì‹œê°„ ë²ˆì—­ ë¡œê·¸ ìˆ˜ì‹ 
    // 'new_translation' ëŒ€ì‹  'partial_translation'ìœ¼ë¡œ ë³€ê²½ëœ ê²ƒì„ ìœ ì§€í•©ë‹ˆë‹¤.
    socket.on("partial_translation", data => {
        logs.push(data);
        renderLogs(logDiv, logs, true);
    });

    // 2. ì„œë²„ì—ì„œ ìš”ì•½ ê²°ê³¼ ìˆ˜ì‹ 
    socket.on("summary_result", summary => {
        console.log("âœ… ì„œë²„ë¡œë¶€í„° ìš”ì•½ ê²°ê³¼ë¥¼ ìˆ˜ì‹ í–ˆìŠµë‹ˆë‹¤.");
        updateSummaryWindowContent(summary);
    });


    function renderLogs(container, dataLogs, scrollToBottom=false){
        container.innerHTML = "";
        dataLogs.forEach(data => {
            const entry = document.createElement("div");
            entry.classList.add("log-entry");

            const timeDiv = document.createElement("div");
            timeDiv.classList.add("timestamp");
            timeDiv.textContent = data.time || "";

            const originalDiv = document.createElement("div");
            originalDiv.classList.add("original");
            originalDiv.textContent = data.original;

            const translatedDiv = document.createElement("div");
            translatedDiv.classList.add("translated");
            translatedDiv.textContent = data.translated;

            entry.appendChild(timeDiv);
            entry.appendChild(originalDiv);
            entry.appendChild(translatedDiv);

            container.appendChild(entry);
            setTimeout(() => entry.classList.add("show"), 10);
        });
        if(scrollToBottom) container.scrollTop = container.scrollHeight;
    }
</script>
</body>
</html>